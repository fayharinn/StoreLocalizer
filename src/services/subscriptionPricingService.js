// GDP per capita data (2023 estimates in USD)
// Source: IMF World Economic Outlook / World Bank
export const GDP_PER_CAPITA = {
  'US': { name: 'United States', gdp: 80412, currency: 'USD', symbol: '$', flag: 'ğŸ‡ºğŸ‡¸' },
  'CH': { name: 'Switzerland', gdp: 98767, currency: 'CHF', symbol: 'CHF', flag: 'ğŸ‡¨ğŸ‡­' },
  'NO': { name: 'Norway', gdp: 87925, currency: 'NOK', symbol: 'kr', flag: 'ğŸ‡³ğŸ‡´' },
  'AU': { name: 'Australia', gdp: 64674, currency: 'AUD', symbol: 'A$', flag: 'ğŸ‡¦ğŸ‡º' },
  'DK': { name: 'Denmark', gdp: 68827, currency: 'DKK', symbol: 'kr', flag: 'ğŸ‡©ğŸ‡°' },
  'SE': { name: 'Sweden', gdp: 55873, currency: 'SEK', symbol: 'kr', flag: 'ğŸ‡¸ğŸ‡ª' },
  'NL': { name: 'Netherlands', gdp: 57025, currency: 'EUR', symbol: 'â‚¬', flag: 'ğŸ‡³ğŸ‡±' },
  'AT': { name: 'Austria', gdp: 52085, currency: 'EUR', symbol: 'â‚¬', flag: 'ğŸ‡¦ğŸ‡¹' },
  'DE': { name: 'Germany', gdp: 48718, currency: 'EUR', symbol: 'â‚¬', flag: 'ğŸ‡©ğŸ‡ª' },
  'BE': { name: 'Belgium', gdp: 49843, currency: 'EUR', symbol: 'â‚¬', flag: 'ğŸ‡§ğŸ‡ª' },
  'CA': { name: 'Canada', gdp: 52722, currency: 'CAD', symbol: 'C$', flag: 'ğŸ‡¨ğŸ‡¦' },
  'GB': { name: 'United Kingdom', gdp: 45850, currency: 'GBP', symbol: 'Â£', flag: 'ğŸ‡¬ğŸ‡§' },
  'FR': { name: 'France', gdp: 42330, currency: 'EUR', symbol: 'â‚¬', flag: 'ğŸ‡«ğŸ‡·' },
  'JP': { name: 'Japan', gdp: 33950, currency: 'JPY', symbol: 'Â¥', flag: 'ğŸ‡¯ğŸ‡µ' },
  'IT': { name: 'Italy', gdp: 34776, currency: 'EUR', symbol: 'â‚¬', flag: 'ğŸ‡®ğŸ‡¹' },
  'ES': { name: 'Spain', gdp: 30103, currency: 'EUR', symbol: 'â‚¬', flag: 'ğŸ‡ªğŸ‡¸' },
  'KR': { name: 'South Korea', gdp: 32423, currency: 'KRW', symbol: 'â‚©', flag: 'ğŸ‡°ğŸ‡·' },
  'PT': { name: 'Portugal', gdp: 24521, currency: 'EUR', symbol: 'â‚¬', flag: 'ğŸ‡µğŸ‡¹' },
  'CZ': { name: 'Czech Republic', gdp: 26379, currency: 'CZK', symbol: 'KÄ', flag: 'ğŸ‡¨ğŸ‡¿' },
  'PL': { name: 'Poland', gdp: 18688, currency: 'PLN', symbol: 'zÅ‚', flag: 'ğŸ‡µğŸ‡±' },
  'HU': { name: 'Hungary', gdp: 18463, currency: 'HUF', symbol: 'Ft', flag: 'ğŸ‡­ğŸ‡º' },
  'GR': { name: 'Greece', gdp: 20867, currency: 'EUR', symbol: 'â‚¬', flag: 'ğŸ‡¬ğŸ‡·' },
  'SA': { name: 'Saudi Arabia', gdp: 23186, currency: 'SAR', symbol: 'Ø±.Ø³', flag: 'ğŸ‡¸ğŸ‡¦' },
  'AE': { name: 'UAE', gdp: 44316, currency: 'AED', symbol: 'Ø¯.Ø¥', flag: 'ğŸ‡¦ğŸ‡ª' },
  'IL': { name: 'Israel', gdp: 52170, currency: 'ILS', symbol: 'â‚ª', flag: 'ğŸ‡®ğŸ‡±' },
  'SG': { name: 'Singapore', gdp: 65233, currency: 'SGD', symbol: 'S$', flag: 'ğŸ‡¸ğŸ‡¬' },
  'HK': { name: 'Hong Kong', gdp: 50983, currency: 'HKD', symbol: 'HK$', flag: 'ğŸ‡­ğŸ‡°' },
  'TW': { name: 'Taiwan', gdp: 32756, currency: 'TWD', symbol: 'NT$', flag: 'ğŸ‡¹ğŸ‡¼' },
  'CN': { name: 'China', gdp: 12720, currency: 'CNY', symbol: 'Â¥', flag: 'ğŸ‡¨ğŸ‡³' },
  'MX': { name: 'Mexico', gdp: 10948, currency: 'MXN', symbol: '$', flag: 'ğŸ‡²ğŸ‡½' },
  'BR': { name: 'Brazil', gdp: 8917, currency: 'BRL', symbol: 'R$', flag: 'ğŸ‡§ğŸ‡·' },
  'RU': { name: 'Russia', gdp: 12195, currency: 'RUB', symbol: 'â‚½', flag: 'ğŸ‡·ğŸ‡º' },
  'TR': { name: 'Turkey', gdp: 10674, currency: 'TRY', symbol: 'â‚º', flag: 'ğŸ‡¹ğŸ‡·' },
  'TH': { name: 'Thailand', gdp: 7066, currency: 'THB', symbol: 'à¸¿', flag: 'ğŸ‡¹ğŸ‡­' },
  'MY': { name: 'Malaysia', gdp: 11993, currency: 'MYR', symbol: 'RM', flag: 'ğŸ‡²ğŸ‡¾' },
  'ID': { name: 'Indonesia', gdp: 4788, currency: 'IDR', symbol: 'Rp', flag: 'ğŸ‡®ğŸ‡©' },
  'PH': { name: 'Philippines', gdp: 3623, currency: 'PHP', symbol: 'â‚±', flag: 'ğŸ‡µğŸ‡­' },
  'VN': { name: 'Vietnam', gdp: 4316, currency: 'VND', symbol: 'â‚«', flag: 'ğŸ‡»ğŸ‡³' },
  'IN': { name: 'India', gdp: 2485, currency: 'INR', symbol: 'â‚¹', flag: 'ğŸ‡®ğŸ‡³' },
  'PK': { name: 'Pakistan', gdp: 1505, currency: 'PKR', symbol: 'â‚¨', flag: 'ğŸ‡µğŸ‡°' },
  'EG': { name: 'Egypt', gdp: 3699, currency: 'EGP', symbol: 'EÂ£', flag: 'ğŸ‡ªğŸ‡¬' },
  'NG': { name: 'Nigeria', gdp: 2184, currency: 'NGN', symbol: 'â‚¦', flag: 'ğŸ‡³ğŸ‡¬' },
  'ZA': { name: 'South Africa', gdp: 6001, currency: 'ZAR', symbol: 'R', flag: 'ğŸ‡¿ğŸ‡¦' },
  'CL': { name: 'Chile', gdp: 15355, currency: 'CLP', symbol: '$', flag: 'ğŸ‡¨ğŸ‡±' },
  'CO': { name: 'Colombia', gdp: 6630, currency: 'COP', symbol: '$', flag: 'ğŸ‡¨ğŸ‡´' },
  'AR': { name: 'Argentina', gdp: 10631, currency: 'ARS', symbol: '$', flag: 'ğŸ‡¦ğŸ‡·' },
  'PE': { name: 'Peru', gdp: 7126, currency: 'PEN', symbol: 'S/', flag: 'ğŸ‡µğŸ‡ª' },
  'NZ': { name: 'New Zealand', gdp: 48249, currency: 'NZD', symbol: 'NZ$', flag: 'ğŸ‡³ğŸ‡¿' },
  'IE': { name: 'Ireland', gdp: 103685, currency: 'EUR', symbol: 'â‚¬', flag: 'ğŸ‡®ğŸ‡ª' },
  'FI': { name: 'Finland', gdp: 50563, currency: 'EUR', symbol: 'â‚¬', flag: 'ğŸ‡«ğŸ‡®' },
  'RO': { name: 'Romania', gdp: 15892, currency: 'RON', symbol: 'lei', flag: 'ğŸ‡·ğŸ‡´' },
  'UA': { name: 'Ukraine', gdp: 4534, currency: 'UAH', symbol: 'â‚´', flag: 'ğŸ‡ºğŸ‡¦' },
}

// Reference GDP (US) for price calculations
const REFERENCE_GDP = GDP_PER_CAPITA['US'].gdp

// Subscription period types
export const SUBSCRIPTION_PERIODS = {
  weekly: { label: 'Weekly', days: 7, multiplier: 0.25 },
  monthly: { label: 'Monthly', days: 30, multiplier: 1 },
  quarterly: { label: '3 Months', days: 90, multiplier: 2.5 },
  biannual: { label: '6 Months', days: 180, multiplier: 4.5 },
  annual: { label: 'Yearly', days: 365, multiplier: 8 },
  lifetime: { label: 'Lifetime', days: null, multiplier: 30 }
}

// Cache for exchange rates
let exchangeRatesCache = null
let exchangeRatesCacheTime = null
const CACHE_DURATION = 60 * 60 * 1000 // 1 hour

/**
 * Fetch live exchange rates from exchangerate-api.com (free, no API key needed)
 */
export async function fetchExchangeRates() {
  // Return cached data if still valid
  if (exchangeRatesCache && exchangeRatesCacheTime && (Date.now() - exchangeRatesCacheTime < CACHE_DURATION)) {
    return { success: true, rates: exchangeRatesCache, cached: true }
  }

  try {
    const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD')
    if (!response.ok) throw new Error('Exchange rate API request failed')
    
    const data = await response.json()
    exchangeRatesCache = data.rates
    exchangeRatesCacheTime = Date.now()
    
    return {
      success: true,
      rates: data.rates,
      lastUpdate: data.time_last_updated,
      cached: false
    }
  } catch (error) {
    console.error('Failed to fetch exchange rates:', error)
    return {
      success: false,
      error: error.message,
      rates: null
    }
  }
}

/**
 * Round price to psychologically appealing values
 */
function roundToNicePrice(price, currency) {
  const largeCurrencies = ['JPY', 'KRW', 'VND', 'IDR', 'CLP', 'COP', 'HUF']
  
  if (largeCurrencies.includes(currency)) {
    if (price < 100) return Math.round(price / 10) * 10
    if (price < 1000) return Math.round(price / 50) * 50
    if (price < 10000) return Math.round(price / 100) * 100
    return Math.round(price / 1000) * 1000
  }

  if (price < 1) return Math.round(price * 100) / 100
  if (price < 5) return Math.round(price * 2) / 2
  if (price < 20) return Math.round(price) - 0.01
  return Math.round(price / 5) * 5 - 0.01
}

/**
 * Calculate GDP-adjusted price for a country
 * Returns the recommended price in USD based on purchasing power
 */
export function calculateRecommendedPrice(basePriceUSD, countryCode, options = {}) {
  const { 
    minMultiplier = 0.25,
    maxMultiplier = 1.3,
  } = options

  const country = GDP_PER_CAPITA[countryCode]
  if (!country) return null

  // Calculate PPP-adjusted multiplier using square root for smoother curve
  const gdpRatio = country.gdp / REFERENCE_GDP
  let multiplier = Math.pow(gdpRatio, 0.5)
  multiplier = Math.max(minMultiplier, Math.min(maxMultiplier, multiplier))

  const recommendedPriceUSD = basePriceUSD * multiplier
  const discount = Math.round((1 - multiplier) * 100)

  return {
    countryCode,
    countryName: country.name,
    flag: country.flag,
    currency: country.currency,
    symbol: country.symbol,
    gdp: country.gdp,
    gdpRatio,
    multiplier,
    basePriceUSD,
    recommendedPriceUSD: Math.round(recommendedPriceUSD * 100) / 100,
    discount: discount > 0 ? discount : 0,
    premium: discount < 0 ? Math.abs(discount) : 0
  }
}

/**
 * Generate complete pricing table with exchange rate conversion
 * This is the main function to use - it gives you everything you need
 */
export async function generatePricingRecommendations(basePriceUSD, options = {}) {
  // Fetch live exchange rates
  const exchangeResult = await fetchExchangeRates()
  const rates = exchangeResult.rates || {}
  
  const results = []
  
  for (const [code, country] of Object.entries(GDP_PER_CAPITA)) {
    const recommendation = calculateRecommendedPrice(basePriceUSD, code, options)
    if (!recommendation) continue

    // Convert recommended USD price to local currency
    const exchangeRate = rates[country.currency] || 1
    const localPrice = recommendation.recommendedPriceUSD * exchangeRate
    const roundedLocalPrice = roundToNicePrice(localPrice, country.currency)
    
    // Also show what the base price would be in local currency (without GDP adjustment)
    const baseLocalPrice = basePriceUSD * exchangeRate
    const roundedBaseLocalPrice = roundToNicePrice(baseLocalPrice, country.currency)

    results.push({
      ...recommendation,
      exchangeRate,
      // Recommended price in local currency (GDP-adjusted)
      localPrice: roundedLocalPrice,
      localPriceFormatted: formatPrice(roundedLocalPrice, country.currency, country.symbol),
      // Base price in local currency (no GDP adjustment, just conversion)
      baseLocalPrice: roundedBaseLocalPrice,
      baseLocalPriceFormatted: formatPrice(roundedBaseLocalPrice, country.currency, country.symbol),
      // Savings compared to just converting USD price
      savingsLocal: roundedBaseLocalPrice - roundedLocalPrice,
      savingsPercent: Math.round(((roundedBaseLocalPrice - roundedLocalPrice) / roundedBaseLocalPrice) * 100)
    })
  }

  // Sort by GDP ratio (highest purchasing power first)
  results.sort((a, b) => b.gdpRatio - a.gdpRatio)

  return {
    basePriceUSD,
    recommendations: results,
    exchangeRatesAvailable: exchangeResult.success,
    exchangeRatesCached: exchangeResult.cached,
    lastUpdate: exchangeResult.lastUpdate
  }
}

/**
 * Format price with currency symbol
 */
function formatPrice(price, currency, symbol) {
  const largeCurrencies = ['JPY', 'KRW', 'VND', 'IDR', 'CLP', 'COP', 'HUF']
  
  if (largeCurrencies.includes(currency)) {
    return `${symbol}${Math.round(price).toLocaleString()}`
  }
  
  return `${symbol}${price.toFixed(2)}`
}

/**
 * Get tier classification based on GDP
 */
export function getTier(gdpRatio) {
  if (gdpRatio >= 0.5) return 'high'
  if (gdpRatio >= 0.2) return 'medium'
  return 'low'
}

/**
 * Generate pricing table (simplified, without exchange rates)
 * Use generatePricingRecommendations for full data
 */
export function generatePricingTable(basePriceUSD, options = {}) {
  const results = []
  
  for (const code of Object.keys(GDP_PER_CAPITA)) {
    const rec = calculateRecommendedPrice(basePriceUSD, code, options)
    if (rec) {
      results.push({
        ...rec,
        tier: getTier(rec.gdpRatio),
        price: rec.recommendedPriceUSD
      })
    }
  }

  return results.sort((a, b) => b.gdpRatio - a.gdpRatio)
}

/**
 * Get pricing tiers summary
 */
export function getPricingTiersSummary(basePriceUSD) {
  const table = generatePricingTable(basePriceUSD)
  
  const tiers = {
    high: table.filter(p => p.tier === 'high'),
    medium: table.filter(p => p.tier === 'medium'),
    low: table.filter(p => p.tier === 'low')
  }

  const avgPrice = (arr) => arr.length ? arr.reduce((sum, p) => sum + p.recommendedPriceUSD, 0) / arr.length : 0

  return {
    tiers,
    stats: {
      avgHigh: avgPrice(tiers.high),
      avgMedium: avgPrice(tiers.medium),
      avgLow: avgPrice(tiers.low),
      totalMarkets: table.length
    }
  }
}

/**
 * Legacy function for backward compatibility
 */
export async function generatePricingTableWithLiveData(basePriceUSD, options = {}) {
  const result = await generatePricingRecommendations(basePriceUSD, options)
  
  return {
    pricing: result.recommendations.map(r => ({
      countryCode: r.countryCode,
      countryName: r.countryName,
      price: r.recommendedPriceUSD,
      multiplier: r.multiplier,
      gdpRatio: r.gdpRatio,
      tier: getTier(r.gdpRatio),
      currency: r.currency,
      symbol: r.symbol,
      flag: r.flag,
      localPrice: r.localPrice,
      localPriceFormatted: r.localPriceFormatted,
      discount: r.discount
    })),
    dataSource: result.exchangeRatesAvailable ? 'Live Exchange Rates' : 'Cached Data',
    isLive: result.exchangeRatesAvailable && !result.exchangeRatesCached
  }
}
